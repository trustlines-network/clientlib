version: "3"
services:
  relay:
    image: trustlines/relay
    container_name: relay
    environment:
      - TRUSTLINES_SYNC_TX_RELAY=1
      - PGHOST
      - PGUSER
      - PGDATABASE
      - PGPASSWORD
    links:
      - "parity:node"
      - "postgres:db"
    volumes:
      - ./config.json:/opt/relay/config.json
      - ./addresses.json:/opt/relay/addresses.json
    ports:
      - "127.0.0.1:5000:5000"
    networks:
      - internal
    restart: unless-stopped
    entrypoint: ""
    command: bash -c "sleep 7; exec tl-relay"

  index:
    image: trustlines/py-eth-index
    networks:
      - internal
    links:
      - "postgres:db"
      - "parity:node"
    environment:
      - PGHOST
      - PGUSER
      - PGDATABASE
      - PGPASSWORD
    restart: unless-stopped
    command: bash -c "sleep 15 && /opt/ethindex/bin/ethindex runsync --jsonrpc http://node:8545 --waittime 200"

  init:
    image: trustlines/py-eth-index
    networks:
      - internal
    links:
      - "postgres:db"
    environment:
      - PGHOST
      - PGUSER
      - PGDATABASE
      - PGPASSWORD
    volumes:
      - ./addresses.json:/opt/ethindex/addresses.json
      - ../../contracts.json:/opt/ethindex/contracts.json
    command: bash -c "sleep 6 && /opt/ethindex/bin/ethindex createtables && /opt/ethindex/bin/ethindex importabi"

  postgres:
    image: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
    networks:
      - internal
      
  parity:
    build:
      context: parity
    container_name: parity
    restart: unless-stopped
    networks:
      - internal
    command: --config=dev --base-path=/home/parity/chaindata --jsonrpc-cors=* --jsonrpc-apis=all --jsonrpc-hosts=all --jsonrpc-interface=0.0.0.0 --unlock=0x00a329c0648769a73afac7f9381e08fb43dbea72 --password=/home/parity/pw
    
  contracts:
    image: trustlines/contracts
    command: ["test", "--file", "addresses.json", "--jsonrpc", "http://node:8545"]
    container_name: contracts
    links:
      - "parity:node"
    volumes:
      - ./addresses.json:/opt/contracts/addresses.json
    networks:
      - internal
       
networks:
  internal:
    external: false

