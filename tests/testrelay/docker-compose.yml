version: "3"
services:
  relay:
    image: trustlines/relay
    container_name: relay
    environment:
      - ETHINDEX=1
      - PGHOST
      - PGUSER
      - PGDATABASE
      - PGPASSWORD
    links:
      - "parity:node"
      - "postgres:db"
    volumes:
      - ./config.json:/opt/relay/config.json
      - ./addresses.json:/opt/relay/addresses.json
    ports:
      - "127.0.0.1:5000:5000"
    networks:
      - internal
    restart: unless-stopped

  index:
    image: trustlines/py-eth-index
    networks:
      - internal
    links:
      - "postgres:db"
      - "parity:node"
    environment:
      - PGHOST
      - PGUSER
      - PGDATABASE
      - PGPASSWORD
    restart: unless-stopped
    command: bash -c "sleep 5 && /opt/ethindex/bin/ethindex runsync --jsonrpc http://node:8545 --waittime 200"

  init:
    image: trustlines/py-eth-index
    networks:
      - internal
    links:
      - "postgres:db"
    environment:
      - PGHOST
      - PGUSER
      - PGDATABASE
      - PGPASSWORD
    volumes:
      - ./addresses.json:/opt/ethindex/addresses.json
      - ../../contracts.json:/opt/ethindex/contracts.json
    command: bash -c "sleep 2 && /opt/ethindex/bin/ethindex createtables && /opt/ethindex/bin/ethindex importabi"

  postgres:
    image: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
    networks:
      - internal
      
  parity:
    build:
      context: ./parity
    container_name: parity
    restart: unless-stopped
    networks:
      - internal
    
  contracts:
    build:
      context: https://github.com/trustlines-network/contracts.git#develop
    command: ["test", "--file", "addresses.json", "--jsonrpc", "http://node:8545"]
    container_name: contracts
    links:
      - "parity:node"
    volumes:
      - ./addresses.json:/contracts/addresses.json
    networks:
      - internal
       
networks:
  internal:
    external: false

